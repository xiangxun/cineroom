<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>threejs加载全局音频对象</title>
    <script
      type="text/javascript"
      src="../node_modules/three/build/three.js"
    ></script>
    <script
      type="text/javascript"
      src="../node_modules/three/examples/js/controls/OrbitControls.js"
    ></script>
    <!-- <script type="text/javascript" src="js/libs/stats.min.js"></script> -->
    <!-- <script type="text/javascript" src="js/libs/dat.gui.min.js"></script> -->
    <!-- <script type="text/javascript" src="js/WebGL.js"></script> -->
    <style>
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
      }
      #overlay {
        position: absolute;
        z-index: 100;
        width: 100%;
        height: 100%;
        background-color: #000000;
        color: #ffffff;
        text-align: center;
      }
      #start_btn {
        margin-top: 300px;
        height: 20px;
        width: 100px;
        color: #ffffff;
        border: 0px;
        outline: 1px solid #ffffff;
        background: transparent;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <audio loop id="music" preload="auto" style="display: none">
      <!-- <source src="../public/audio/1.mp3"></source> -->
      <!-- <source src="sounds/test1.ogg"></source> -->
    </audio>

    <div id="overlay">
      <button id="start_btn">点击播放</button>
      <p>Automatic audio playback requires a user interaction.</p>
    </div>

    <script>
      document
        .getElementById("start_btn")
        .addEventListener("click", init, false);

      var scene, renderer, camera, controls, stats;
      function init() {
        document.getElementById("overlay").remove();

        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer({
          antialias: true,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 20, 50);
        camera.lookAt(scene.position);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 0.1;
        controls.maxDistance = 1000;

        scene.add(new THREE.AmbientLight(0x404040));

        var dLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dLight.position.set(10, 10, 0);
        dLight.castShadow = true;
        dLight.shadow.camera.top = 10;
        dLight.shadow.camera.bottom = -10;
        dLight.shadow.camera.left = -10;
        dLight.shadow.camera.right = 10;
        dLight.shadow.camera.near = 10;
        dLight.shadow.camera.far = 50;
        scene.add(dLight);

        initModel();

        animate();
      }

      var axes;
      var mesh;
      function initModel() {
        axes = new THREE.AxesHelper(30);
        axes.visible = false;
        scene.add(axes);

        var grid = new THREE.GridHelper(50, 50, 0xff00ff, 0xffff00);
        grid.material.transparent = true;
        grid.material.opacity = 0.5;
        scene.add(grid);

        var ground = new THREE.Mesh(
          new THREE.PlaneBufferGeometry(50, 50, 1),
          new THREE.MeshPhongMaterial({
            color: 0x999999,
          })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        //建立球模型
        mesh = new THREE.Mesh(
          new THREE.SphereBufferGeometry(2, 15, 15),
          new THREE.MeshPhongMaterial({
            color: 0xffffff * Math.random(),
            flatShading: true,
          })
        );
        mesh.position.set(0, 3, 0);
        mesh.castShadow = true;
        scene.add(mesh);

        // 初始化一个监听
        var listener = new THREE.AudioListener();
        camera.add(listener); // 把监听添加到camera

        // 初始化音频对象,并加入监听
        var sound = new THREE.Audio(listener);
        //scene.add(sound);// 添加一个音频对象到场景中

        // 初始化一个加载器,然后加载资源
        var auLoader = new THREE.AudioLoader();
        auLoader.load(
          "../public/audio/1.mp3",
          //"sounds/test1.ogg",
          function (buffer) {
            sound.setBuffer(buffer); // 给一个加载器对象设置音频对象的缓存
            sound.play(); // 播放音频
          },
          function (xhr) {
            // onProgress回调
            console.log(
              "audio " + (xhr.loaded / xhr.total) * 100 + " % loaded"
            );
          },
          function (error) {
            // onError回调
            console.error("an error happened !");
          }
        );
        mesh.add(sound);

        //不使用threejs加载器播放音频
        /*				var music=document.getElementById("music");
				music.play();
				sound.setMediaElementSource(music);
				mesh.add(sound);*/
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        renderer.render(scene, camera);

        mesh.rotation.y += 0.01;
        controls.update();
        window.onresize = onWindowResize();
        requestAnimationFrame(animate);
      }
    </script>
  </body>
</html>
